<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Hugues BRETIN">
<title>vagrant-ansible-build-ovf</title>
<link rel="stylesheet" href="file:///home/hbretin/.config/Brackets/extensions/user/nerk.asciidoc-preview/themes/asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</head>
<body class="article">
<div id="header">
<h1>vagrant-ansible-build-ovf</h1>
<div class="details">
<span id="author" class="author">Hugues BRETIN</span><br>
<span id="email" class="email"><a href="http://github.com/uguy" class="bare">http://github.com/uguy</a></span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is a simple sample on how to get started generating OVF file from a <a href="https://www.vagrantup.com/">Vagrant</a> box tuned with <a href="http://www.ansible.com/home">Ansible</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
you need a linux box (or an Ansible/bash capable one) to run it
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_forge_your_own_cloud_images">Forge your own cloud images</a></li>
<li><a href="#_setup_environment">Setup environment</a></li>
<li><a href="#_build_the_image">Build the image</a></li>
<li><a href="#_how_this_works">How this works</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forge_your_own_cloud_images">Forge your own cloud images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you cant go for docker based deployment, you might want to forge deployable images in order to push them to your favourite cloud provider&#8217;s catalog (ie. using glance for <a href="https://www.openstack.org/">OpenStack</a> ones)</p>
</div>
<div class="paragraph">
<p>Forging a deployable image means creating an environment from a base distro and customize it to suit your needs (install custom services/config/&#8230;&#8203;)</p>
</div>
<div class="paragraph">
<p><strong>Vagrant</strong> is a great and well known tool for managing local virtual machines with virtual box (but not only), so it is seems to be a natural choice to setup the base distro.</p>
</div>
<div class="paragraph">
<p>Now <strong>Ansible</strong> is also an "extremly pleasant" tool for box configuation (in fact your all infrastructure if you wish).
Since some cloud provider impose some packages to be present to accept custom images as valid ones, we can easily use ansible for that !</p>
</div>
<div class="paragraph">
<p>This sample shows how to build an OpenStack compliant custom <a href="http://en.wikipedia.org/wiki/Open_Virtualization_Format">OVF</a> files from Ubuntu/trusty64 with custom packages on it (cowsay,fortune) and configuration</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_environment">Setup environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Install Vagrant, Ansible</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># Vagrant
$ sudo apt-get install -y vagrant virtualbox
# Ansible
$ sudo apt-get install -y python-dev python-pip
$ sudo pip install ansible</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_the_image">Build the image</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./build-image.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The produced OVF file should be in the relative dist folder :)</p>
</div>
<div class="paragraph">
<p>You can use your cloud provider client to upload it and make it available for instanciation.<br></p>
</div>
<div class="paragraph">
<p><em>But before this, make sure your box has been <strong>secured</strong> via ansible (users,keys,packages,&#8230;&#8203;) Vagrant user should be removed and probably a lot of other things needs to be done, just improve the playbook to do so ;)</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ glance image-create --progress --name "funny-ubuntu-trusty-1.0.0" --is-public=false --container-format=ovf --disk-format=vmdk --file dist/funny-ubuntu-trusty-1.0.0.ovf</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_this_works">How this works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The build script destroy the vagrant box if it exist and recreate it.</p>
</div>
<div class="listingblock">
<div class="title">source: build-image.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">vagrant destroy -f &amp;&amp; vagrant up</code></pre>
</div>
</div>
<div class="paragraph">
<p>The box defined is an official Ubuntu Trusty64 fetched by Vagrant from <a href="https://vagrantcloud.com/ubuntu/boxes/trusty64">Vagrantcloud</a>
The name of the virtual machine is fixed to be able to retrieve it from the script</p>
</div>
<div class="listingblock">
<div class="title">source: Vagrantfile</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ruby" data-lang="ruby">  config.vm.box = "ubuntu/trusty64"

  config.vm.provider "virtualbox" do |vb|
    vb.gui = false
    # name is important since used to target the vm from VBoxManage tool
    vb.name = "funny-ubuntu-trusty-1.0.0"
  end</code></pre>
</div>
</div>
<div class="paragraph">
<p>We specify ansible as our provider for the vm customization. Vagrant will run ansible/playbook.yml against the vm once started.<br>
Ansible rocks and is really worth having a look !</p>
</div>
<div class="listingblock">
<div class="title">source: Vagrantfile</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ruby" data-lang="ruby">  config.vm.provision "ansible" do |ansible|
    ansible.playbook = "ansible/playbook.yml"
    ansible.verbose = "v"
  end</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last consist in exporting the vm as an OVF file. First it needs to be stopped ( vagrant halt) and then a simple call to VBoxManage will do.</p>
</div>
<div class="listingblock">
<div class="title">source: build-image.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ VBoxManage export $VM_NAME -o $SCRIPTPATH/dist/$VM_NAME.ovf --ovf20 --manifest</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all folks !</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-04-02 11:18:29 CEST
</div>
</div>
</body>
</html>